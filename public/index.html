<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Ï∫êÏπòÎßàÏù∏Îìú WIDE</title>
    <style>
      :root { --main-bg: #e9ecef; --panel-bg: #ffffff; --primary: #4a90e2; --accent: #ffeb3b; }
      body {
        font-family: "Pretendard", sans-serif; background: var(--main-bg); margin: 0;
        display: flex; flex-direction: column; height: 100vh; overflow: hidden;
      }
      #login-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); display: flex; justify-content: center; align-items: center; z-index: 1000;
      }
      .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; }
      header {
        background: var(--primary); color: white; padding: 15px 30px;
        display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box;
      }
      .main-container {
        display: flex; flex: 1; padding: 20px; gap: 20px; justify-content: center;
        height: calc(100vh - 60px); box-sizing: border-box;
      }
      .user-list-panel {
        width: 180px; background: var(--panel-bg); border-radius: 15px;
        padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-y: auto;
      }
      .user-item {
        padding: 10px; border-radius: 8px; background: #f8f9fa; margin-bottom: 8px;
        display: flex; justify-content: space-between; font-size: 0.9em;
      }
      .user-item.painter { border: 2px solid var(--accent); background: #fffde7; font-weight: bold; }
      .canvas-area {
        flex: 1; max-width: 850px; background: var(--panel-bg); border-radius: 15px;
        padding: 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      canvas { background: #fff; border: 1px solid #ddd; border-radius: 10px; cursor: crosshair; width: 100%; height: auto; touch-action: none; }
      
      /* ÏÉâÏÉÅ Ìà¥Î∞î Í∞úÏÑ† */
      .toolbar { 
        margin-top: 15px; 
        display: flex; 
        flex-wrap: wrap; /* ÏÉâÏÉÅÏù¥ ÎßéÏïÑÏßÄÎ©¥ Îã§Ïùå Ï§ÑÎ°ú ÎÑòÏñ¥Í∞ÄÍ≤å ÏÑ§Ï†ï */
        justify-content: center;
        gap: 8px; 
        padding: 12px 20px; 
        background: #f1f3f5; 
        border-radius: 20px; 
        max-width: 100%;
      }
      .color-dot { 
        width: 24px; 
        height: 24px; 
        border-radius: 50%; 
        cursor: pointer; 
        border: 2px solid white; 
        transition: transform 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .color-dot:hover { transform: scale(1.2); }
      .color-dot.active { transform: translateY(-4px) scale(1.2); border-color: #333; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
      
      .tool-btn { border: none; padding: 6px 14px; cursor: pointer; border-radius: 10px; font-weight: bold; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .tool-btn:hover { background: #eee; }

      .sidebar {
        width: 280px; display: flex; flex-direction: column; background: var(--panel-bg);
        border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); height: 100%; box-sizing: border-box;
      }
      #chat-box { flex: 1; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 15px; padding-right: 5px; word-break: break-all; }
      .system { color: #28a745; font-weight: bold; text-align: center; margin: 8px 0; background: #e8f5e9; padding: 8px; border-radius: 8px; font-size: 0.85em; }
    </style>
  </head>
  <body>
    <div id="login-overlay">
      <div class="login-box">
        <h2>üé® Ï∫êÏπòÎßàÏù∏Îìú</h2>
        <input type="text" id="nickname-input" placeholder="ÎãâÎÑ§ÏûÑ" maxlength="10" style="padding: 10px;" onkeypress="if(event.keyCode==13) joinGame()"/><br /><br />
        <button onclick="joinGame()" style="padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer">ÏûÖÏû•</button>
      </div>
    </div>
    <header>
      <div style="font-weight: bold;">CATCH MIND</div>
      <div id="status-text">ÎåÄÍ∏∞ Ï§ë...</div>
      <div id="word-display" style="color: var(--accent); font-weight: bold;"></div>
    </header>
    <div class="main-container">
      <div class="user-list-panel" id="user-list"><strong>PLAYERS</strong></div>
      <div class="canvas-area">
        <canvas id="paint" width="800" height="500"></canvas>
        <div class="toolbar" id="palette">
          <div class="color-dot active" style="background: black" onclick="pickColor('black', this)"></div>
          <div class="color-dot" style="background: #808080" onclick="pickColor('#808080', this)"></div>
          <div class="color-dot" style="background: #e74c3c" onclick="pickColor('#e74c3c', this)"></div>
          <div class="color-dot" style="background: #e67e22" onclick="pickColor('#e67e22', this)"></div>
          <div class="color-dot" style="background: #f1c40f" onclick="pickColor('#f1c40f', this)"></div>
          <div class="color-dot" style="background: #2ecc71" onclick="pickColor('#2ecc71', this)"></div>
          <div class="color-dot" style="background: #1abc9c" onclick="pickColor('#1abc9c', this)"></div>
          <div class="color-dot" style="background: #3498db" onclick="pickColor('#3498db', this)"></div>
          <div class="color-dot" style="background: #9b59b6" onclick="pickColor('#9b59b6', this)"></div>
          <div class="color-dot" style="background: #ffaec8" onclick="pickColor('#ffaec8', this)"></div>
          <div class="color-dot" style="background: #88563b" onclick="pickColor('#88563b', this)"></div>
          
          <div style="width: 10px;"></div> <button class="tool-btn" onclick="pickColor('white', this)" style="color: #555;">ÏßÄÏö∞Í∞ú</button>
          <button class="tool-btn" onclick="clearCanvasReq()" style="background: #ff7675; color: white;">Ï†ÑÏ≤¥ÏÇ≠Ï†ú</button>
        </div>
      </div>
      <div class="sidebar">
        <div id="chat-box"></div>
        <div style="display: flex; gap: 5px">
          <input type="text" id="chat-input" style="flex: 1; padding: 8px" placeholder="Ï†ïÎãµ ÏûÖÎ†•..." />
          <button onclick="sendMessage()">Ï†ÑÏÜ°</button>
        </div>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const canvas = document.getElementById("paint");
      const ctx = canvas.getContext("2d");
      const chatBox = document.getElementById("chat-box");
      const chatInput = document.getElementById("chat-input");
      const userListDiv = document.getElementById("user-list");

      let isDrawing = false, isPainter = false, currentColor = "black", currentPainterId = null;

      function joinGame() {
        const nickname = document.getElementById("nickname-input").value.trim();
        if (nickname) { socket.emit("set_nickname", nickname); document.getElementById("login-overlay").style.display = "none"; }
      }

      socket.on("update_players", (players) => {
        userListDiv.innerHTML = "<strong>PLAYERS</strong>";
        for (let id in players) {
          const div = document.createElement("div");
          div.className = "user-item" + (id === currentPainterId ? " painter" : "");
          div.innerHTML = `<span>${id === socket.id ? "ÎÇò" : players[id].name}</span><span>${players[id].score}</span>`;
          userListDiv.appendChild(div);
        }
      });

      socket.on("new_round", (data) => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        currentPainterId = data.painterId;
        isPainter = socket.id === data.painterId;
        document.getElementById("status-text").innerText = isPainter ? "üñåÔ∏è ÎãπÏã†ÏùÄ Ï∂úÏ†úÏûêÏûÖÎãàÎã§!" : "üßê Ï†ïÎãµÏùÑ ÎßûÏ∂∞Î≥¥ÏÑ∏Ïöî!";
        document.getElementById("word-display").innerText = "";
        document.getElementById("palette").style.opacity = isPainter ? "1" : "0.3";
        document.getElementById("palette").style.pointerEvents = isPainter ? "auto" : "none";
      });

      socket.on("get_answer", (ans) => { document.getElementById("word-display").innerText = "Ï†úÏãúÏñ¥: " + ans; });

      function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ ÎåÄÏùë
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { 
          x: (clientX - rect.left) * (canvas.width / rect.width), 
          y: (clientY - rect.top) * (canvas.height / rect.height) 
        };
      }

      // Í∑∏Î¶¨Í∏∞ Ïù¥Î≤§Ìä∏ (ÎßàÏö∞Ïä§ & ÌÑ∞Ïπò ÌÜµÌï©)
      const startDrawing = (e) => {
        if (!isPainter) return;
        isDrawing = true;
        const coords = getCoords(e);
        ctx.beginPath(); 
        ctx.moveTo(coords.x, coords.y);
        socket.emit("start_drawing", { x: coords.x, y: coords.y, color: currentColor });
      };

      const moveDrawing = (e) => {
        if (!isDrawing || !isPainter) return;
        if (e.cancelable) e.preventDefault();
        const coords = getCoords(e);
        const data = { x: coords.x, y: coords.y, color: currentColor };
        draw(data);
        socket.emit("drawing", data);
      };

      const stopDrawing = () => { 
        if (isPainter && isDrawing) { 
          isDrawing = false; 
          socket.emit("stop_drawing"); 
        } 
      };

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", moveDrawing);
      window.addEventListener("mouseup", stopDrawing);

      canvas.addEventListener("touchstart", startDrawing, {passive: false});
      canvas.addEventListener("touchmove", moveDrawing, {passive: false});
      canvas.addEventListener("touchend", stopDrawing);

      socket.on("start_drawing", (data) => {
        if (!isPainter) {
          ctx.beginPath();
          ctx.strokeStyle = data.color;
          ctx.lineWidth = data.color === "white" ? 30 : 5;
          ctx.moveTo(data.x, data.y);
        }
      });

      socket.on("drawing", (data) => {
        if (!isPainter) {
          ctx.strokeStyle = data.color;
          ctx.lineWidth = data.color === "white" ? 30 : 5;
          ctx.lineTo(data.x, data.y);
          ctx.stroke();
        }
      });

      socket.on("stop_drawing", () => ctx.beginPath());

      function draw(data) {
        ctx.lineWidth = data.color === "white" ? 30 : 5;
        ctx.lineCap = "round"; ctx.lineJoin = "round";
        ctx.strokeStyle = data.color;
        ctx.lineTo(data.x, data.y); ctx.stroke();
      }

      function clearCanvasReq() {
        if (!isPainter) return;
        if (confirm("Í∑∏Î¶ºÏùÑ Î™®Îëê ÏßÄÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?")) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          socket.emit("clear_canvas"); // ÏÑúÎ≤ÑÏóê Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Ïã†Ìò∏ Ï∂îÍ∞Ä ÌïÑÏöî Ïãú
        }
      }
      
      socket.on("clear_canvas", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      function sendMessage() {
        const msg = chatInput.value.trim();
        if (msg) { socket.emit("send_message", msg); chatInput.value = ""; }
      }
      
      socket.on("receive_message", (data) => {
        const div = document.createElement("div");
        if (data.user === "System") div.className = "system";
        div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
        chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
      });
      
      chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
      
      function pickColor(color, el) {
        if (!isPainter) return;
        currentColor = color;
        document.querySelectorAll(".color-dot").forEach((d) => d.classList.remove("active"));
        if (el && el.classList.contains("color-dot")) el.classList.add("active");
      }
    </script>
  </body>
</html>


